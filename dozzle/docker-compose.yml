# Run with docker compose up -d
services:
  dozzle:
    image: amir20/dozzle:latest
    volumes:
      - ./data:/data
      - /var/run/docker.sock:/var/run/docker.sock
    ports:
      - "127.0.0.1:${PORT}:8080"
    depends_on:
      dozzle-generate-users:
        condition: service_completed_successfully
    environment:
      # Uncomment to enable container actions (stop, start, restart). See https://dozzle.dev/guide/actions
      DOZZLE_ENABLE_ACTIONS: ${DOZZLE_ENABLE_ACTIONS}
      DOZZLE_ENABLE_SHELL: ${DOZZLE_ENABLE_SHELL}
      DOZZLE_AUTH_PROVIDER: ${DOZZLE_AUTH_PROVIDER}
  dozzle-generate-users:
    build: 
      context: .
      no_cache: true
      dockerfile_inline: |
        FROM epicsoft/bcrypt AS bcryptenv
        FROM alpine
        COPY --from=bcryptenv /usr/local/bin/bcrypt /usr/local/bin/bcrypt
        COPY ./mkusers.sh /
    volumes:
      - ./data:/data
    command: sh /mkusers.sh
    environment:
      DOZZLE_AUTH_EMAIL: ${DOZZLE_AUTH_EMAIL}
      DOZZLE_AUTH_PASSWORD: ${DOZZLE_AUTH_PASSWORD}
