<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>GPT-OSS via Ollama</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/marked@12.0.0/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.8/dist/purify.min.js"></script>
  <style>
    :root {
      /* Dark mode color palette */
      --text-primary: #F9FAFB;
      --text-secondary: #9CA3AF;
      --container-bg: #1F2937;
      --page-bg-start: #0F172A;
      --page-bg-end: #1E293B;
      --border-color: #374151;
      --user-message-bg: #3B82F6;
      --user-message-text: #FFFFFF;
      --bot-message-bg: #374151;
      --bot-message-text: #F3F4F6;
      --input-bg: #111827;
      --icon-bg: #3B82F6;
      --ready-pill-bg: #111827;
      --ready-dot-color: #10B981;
      --shadow-color: rgba(0, 0, 0, 0.5);
      --focus-ring: rgba(59, 130, 246, 0.5);
      --accent-gradient-start: #6366F1;
      --accent-gradient-end: #3B82F6;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    .link {
      color: var(--user-message-bg);
      text-decoration: underline;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, var(--page-bg-start), var(--page-bg-end));
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      color: var(--text-primary);
      padding: 20px;
      position: relative;
      overflow: hidden;
    }

    body::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: radial-gradient(circle at 20% 50%, rgba(59, 130, 246, 0.1) 0%, transparent 50%),
                  radial-gradient(circle at 80% 80%, rgba(99, 102, 241, 0.1) 0%, transparent 50%);
      pointer-events: none;
      z-index: 0;
    }

    #chatbox {
      background: var(--container-bg);
      width: 100%;
      max-width: 880px;
      height: 90vh;
      max-height: 800px;
      display: flex;
      flex-direction: column;
      border-radius: 24px;
      box-shadow: 0 20px 60px var(--shadow-color), 0 0 0 1px rgba(255, 255, 255, 0.05);
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, 0.1);
      position: relative;
      z-index: 1;
      backdrop-filter: blur(10px);
    }

    #header {
      padding: 24px;
      display: flex;
      align-items: center;
      gap: 16px;
      flex-shrink: 0;
      border-bottom: 1px solid var(--border-color);
      background: rgba(17, 24, 39, 0.5);
    }
    
    .header-icon {
        width: 40px;
        height: 40px;
        background: linear-gradient(135deg, var(--accent-gradient-start), var(--accent-gradient-end));
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 10px;
        font-weight: 600;
        font-size: 1.2em;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }

    .header-title {
      font-size: 1.5em;
      font-weight: 600;
      background: linear-gradient(135deg, #F9FAFB, #D1D5DB);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    #status-indicators {
        display: flex;
        gap: 12px;
        padding: 20px 24px;
        border-bottom: 1px solid var(--border-color);
        flex-shrink: 0;
        background: rgba(17, 24, 39, 0.3);
        align-items: center;
        justify-content: space-between;
    }

    .pill {
        display: flex;
        align-items: center;
        gap: 8px;
        background-color: var(--ready-pill-bg);
        padding: 8px 14px;
        border-radius: 20px;
        font-size: 0.875em;
        font-weight: 500;
        color: var(--text-secondary);
        border: 1px solid var(--border-color);
        transition: all 0.2s ease;
    }

    .pill:hover {
        border-color: rgba(59, 130, 246, 0.5);
        background-color: rgba(59, 130, 246, 0.1);
    }

    .pill-dot {
        width: 8px;
        height: 8px;
        background-color: var(--ready-dot-color);
        border-radius: 50%;
        box-shadow: 0 0 8px var(--ready-dot-color);
        animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    #messages {
      flex: 1;
      padding: 24px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    /* Scrollbar styles */
    #messages::-webkit-scrollbar { width: 8px; }
    #messages::-webkit-scrollbar-track { background: transparent; }
    #messages::-webkit-scrollbar-thumb { 
      background: var(--border-color); 
      border-radius: 4px; 
    }
    #messages::-webkit-scrollbar-thumb:hover { 
      background: #4B5563; 
    }


    .message-wrapper {
        display: flex;
        max-width: 85%;
        opacity: 0;
        transform: translateY(10px);
        animation: fadeInMessage 0.3s ease-out forwards;
    }

    @keyframes fadeInMessage {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message-wrapper.user { align-self: flex-end; }
    .message-wrapper.bot { align-self: flex-start; }

    .message {
      padding: 12px 18px;
      border-radius: 18px;
      line-height: 1.6;
      word-wrap: break-word;
    }

    .message-wrapper.user .message {
      background: linear-gradient(135deg, var(--accent-gradient-start), var(--accent-gradient-end));
      color: var(--user-message-text);
      border-bottom-right-radius: 6px;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
    }

    .message-wrapper.bot .message {
      background: var(--bot-message-bg);
      color: var(--bot-message-text);
      border-bottom-left-radius: 6px;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    /* Thinking animation for bot */
    .message.thinking {
        display: flex;
        gap: 5px;
        align-items: center;
    }
    .message.thinking span {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background-color: var(--text-secondary);
        animation: bounce 1.4s infinite ease-in-out both;
    }
    .message.thinking span:nth-child(1) { animation-delay: -0.32s; }
    .message.thinking span:nth-child(2) { animation-delay: -0.16s; }
    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1.0); }
    }


    #input-area {
      padding: 24px;
      border-top: 1px solid var(--border-color);
      flex-shrink: 0;
      position: relative;
      background: rgba(17, 24, 39, 0.5);
    }

    #prompt {
      width: 100%;
      padding: 14px 52px 14px 20px;
      border: 1px solid var(--border-color);
      border-radius: 14px;
      background: var(--input-bg);
      color: var(--text-primary);
      font-size: 1em;
      font-family: 'Inter', sans-serif;
      transition: all 0.2s ease;
    }

    #prompt:focus {
      outline: none;
      border-color: var(--user-message-bg);
      box-shadow: 0 0 0 3px var(--focus-ring);
      background: rgba(17, 24, 39, 0.8);
    }
    
    #prompt::placeholder {
        color: var(--text-secondary);
    }

    button#send-button {
      position: absolute;
      right: 40px;
      top: 50%;
      transform: translateY(-50%);
      background: transparent;
      border: none;
      cursor: pointer;
      padding: 8px;
      border-radius: 8px;
      color: var(--text-secondary);
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    button#send-button:hover {
        color: var(--user-message-bg);
        background: rgba(59, 130, 246, 0.1);
        transform: translateY(-50%) scale(1.05);
    }
    
    button#send-button:active {
        transform: translateY(-50%) scale(0.95);
    }
    
    button#send-button svg {
        width: 22px;
        height: 22px;
    }

    /* Markdown styling */
    .message h1, .message h2, .message h3, 
    .message h4, .message h5, .message h6 {
        margin: 0.5em 0 0.3em 0;
        font-weight: 600;
        line-height: 1.3;
    }

    .message h1 { font-size: 1.5em; }
    .message h2 { font-size: 1.3em; }
    .message h3 { font-size: 1.1em; }

    .message p {
        margin: 0.5em 0;
    }

    .message p:first-child {
        margin-top: 0;
    }

    .message p:last-child {
        margin-bottom: 0;
    }

    .message code {
        background-color: rgba(0, 0, 0, 0.3);
        padding: 2px 6px;
        border-radius: 4px;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 0.9em;
    }

    .message-wrapper.bot .message code {
        background-color: rgba(0, 0, 0, 0.4);
        color: #60A5FA;
    }

    .message-wrapper.user .message code {
        background-color: rgba(255, 255, 255, 0.2);
        color: #FFFFFF;
    }

    .message pre {
        background-color: rgba(0, 0, 0, 0.4);
        padding: 12px;
        border-radius: 8px;
        overflow-x: auto;
        margin: 0.8em 0;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .message-wrapper.bot .message pre {
        background-color: rgba(0, 0, 0, 0.5);
    }

    .message-wrapper.user .message pre {
        background-color: rgba(0, 0, 0, 0.3);
    }

    .message pre code {
        background: none;
        padding: 0;
        border-radius: 0;
        font-size: 0.875em;
    }

    .message ul, .message ol {
        margin: 0.5em 0;
        padding-left: 1.5em;
    }

    .message li {
        margin: 0.3em 0;
    }

    .message blockquote {
        border-left: 3px solid var(--user-message-bg);
        padding-left: 1em;
        margin: 0.8em 0;
        opacity: 0.8;
        font-style: italic;
    }

    .message a {
        color: var(--user-message-bg);
        text-decoration: underline;
    }

    .message a:hover {
        opacity: 0.8;
    }

    .message strong {
        font-weight: 600;
    }

    .message em {
        font-style: italic;
    }

    .message hr {
        border: none;
        border-top: 1px solid rgba(255, 255, 255, 0.2);
        margin: 1em 0;
    }

    .message table {
        border-collapse: collapse;
        margin: 0.8em 0;
        width: 100%;
    }

    .message th, .message td {
        border: 1px solid rgba(255, 255, 255, 0.1);
        padding: 0.5em;
        text-align: left;
    }

    .message th {
        background-color: rgba(0, 0, 0, 0.3);
        font-weight: 600;
    }

  </style>
</head>
<body>
  <div id="chatbox">
    <div id="header">
        <div class="header-icon">I</div>
        <div class="header-title">OpenAI Open Source GPT-OSS via Ollama</div>
    </div>
    <div id="status-indicators">
        <div class="pill"><span class="pill-dot"></span>Online</div>
        <div><a href="https://docs.dollardeploy.com/blog/openai-gpt-oss/" class="link" target="_blank">Read more about GPT-OSS</a></div>
    </div>
    <div id="messages">
    </div>
    <div id="input-area">
      <input id="prompt" type="text" placeholder="Ask anything" />
      <button id="send-button" onclick="sendPrompt()" title="Send">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M3.478 2.405a.75.75 0 00-.926.94l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.405z" /></svg>
      </button>
    </div>
  </div>

  <script>
    const promptInput = document.getElementById("prompt");
    const messagesDiv = document.getElementById("messages");

    // Configure marked options
    marked.setOptions({
      breaks: true,
      gfm: true,
      headerIds: false,
      mangle: false
    });

    function formatMarkdown(text) {
      if (!text) return null;
      
      // Convert markdown to HTML
      const html = marked.parse(text);
      
      // Sanitize HTML to prevent XSS attacks
      const cleanHtml = DOMPurify.sanitize(html, {
        ALLOWED_TAGS: ['p', 'br', 'strong', 'em', 'u', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 
                       'ul', 'ol', 'li', 'blockquote', 'code', 'pre', 'a', 'hr', 'table', 
                       'thead', 'tbody', 'tr', 'th', 'td'],
        ALLOWED_ATTR: ['href', 'title', 'alt']
      });
      
      // Create a temporary container and parse the HTML into DOM nodes
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = cleanHtml;
      
      // Return a document fragment with all the nodes
      const fragment = document.createDocumentFragment();
      while (tempDiv.firstChild) {
        fragment.appendChild(tempDiv.firstChild);
      }
      
      return fragment;
    }

    async function sendPrompt() {
      const userPrompt = promptInput.value.trim();
      if (!userPrompt) return;

      appendMessage(userPrompt, 'user');
      promptInput.value = "";

      const thinkingMessage = appendThinkingMessage();
      scrollToBottom();

      try {
        const response = await fetch("/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ prompt: userPrompt })
        });

        if (!response.ok) {
            const errorData = await response.text();
            throw new Error(`Server responded with ${response.status}: ${errorData}`);
        }
        
        const data = await response.json();
        const markdownNode = formatMarkdown(data.response || "No response received.");
        updateBotMessage(thinkingMessage, markdownNode);
      } catch (err) {
        updateBotMessage(thinkingMessage, "Error: " + err.message);
        console.error("Fetch error:", err);
      }
      scrollToBottom();
    }
    
    function createMessageWrapper(type) {
        const wrapper = document.createElement("div");
        wrapper.className = `message-wrapper ${type}`;
        return wrapper;
    }

    function appendMessage(text, type) {
        const wrapper = createMessageWrapper(type);
        const messageDiv = document.createElement("div");
        messageDiv.className = "message";
        messageDiv.textContent = text;
        wrapper.appendChild(messageDiv);
        messagesDiv.appendChild(wrapper);
        return wrapper;
    }

    function appendThinkingMessage() {
        const wrapper = createMessageWrapper('bot');
        const messageDiv = document.createElement("div");
        messageDiv.className = "message thinking";
        messageDiv.innerHTML = `<span></span><span></span><span></span>`;
        wrapper.appendChild(messageDiv);
        messagesDiv.appendChild(wrapper);
        return wrapper;
    }

    function updateBotMessage(thinkingMessageWrapper, newTextOrElement) {
        const messageDiv = thinkingMessageWrapper.querySelector('.message');
        messageDiv.classList.remove("thinking");
        messageDiv.innerHTML = '';
        
        if (typeof newTextOrElement === 'string') {
            messageDiv.textContent = newTextOrElement;
        } else if (newTextOrElement instanceof DocumentFragment || newTextOrElement instanceof Node) {
            // Append as DOM node or fragment
            messageDiv.appendChild(newTextOrElement);
        } else {
            // Fallback to text content
            messageDiv.textContent = String(newTextOrElement);
        }
    }

    function scrollToBottom() {
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    promptInput.addEventListener("keypress", function(event) {
        if (event.key === "Enter" && !event.shiftKey) {
            event.preventDefault();
            sendPrompt();
        }
    });

    window.onload = () => {
      appendMessage("Hello from OpenAI Open Source GPT-OSS!", 'bot');
    };
  </script>
</body>
</html>